---
title: "Project 3"
author: "Jeffrey Zhang and Jaclyn Nguyen"
date: "Monday, February 16, 2015"
output: html_document
---

Project 3 required Jeffrey and I to import a large dataset into Oracle Server and call the data into RStudio for analysis. Below will describe the dataset and the following analysis. 

Dataset: GOVSPENDING2007, GOVSPENDING2007, GOVSPENDING2008, CENSUSCOUNTY

Oracle SQL Developer: C##CS329E_JCN565

__1. Loading of R packages: RCurl, ggplot2, extrafont, jsonlite, dplyr, tidyr (R code not shown)__

```{r, include=FALSE}
library(RCurl)
library (ggplot2)
library(extrafont)
require("jsonlite")
require(dplyr)
require(tidyr)
```

__2. Import dataset from Oracle server__
```{r}
source("../01 data/df_06.R",echo = T)
tbl_df(df_06)
source("../01 data/df_07.R",echo = T)
tbl_df(df_07)
source("../01 data/dfcensus.R",echo = T)
tbl_df(dfpop)
```
__3. begin analysis__
First we want to know how many federal funds that each city has. A city could receive the federal funds many times a year and there are also some blank entries (no city names). I did these data wrangling in the following: 

First I plotted the original dataset for df_06
```{r}
df_06 %>% select(RECIPIENT_CITY_NAME,FED_FUNDING_AMOUNT_06) %>% ggplot(aes(x=RECIPIENT_CITY_NAME, y=FED_FUNDING_AMOUNT_06,color=RECIPIENT_CITY_NAME))  + geom_point() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

I filtered the blank entries for both df_06 and df_07

```{r}
df_06_city_spending <- df_06 %>% select(RECIPIENT_CITY_NAME,FED_FUNDING_AMOUNT_06) %>% filter(RECIPIENT_CITY_NAME != "")
df_07_city_spending <- df_07 %>% select(RECIPIENT_CITY_NAME,FED_FUNDING_AMOUNT_07) %>% filter(RECIPIENT_CITY_NAME != "")
```

I sum the totol funds for each city for both df_06 and df_07
```{r}
df_06_city_total_fund <- df_06_city_spending %>% select(RECIPIENT_CITY_NAME) %>% group_by(RECIPIENT_CITY_NAME) %>% summarize(total_spending = sum(df_06_city_spending$FED_FUNDING_AMOUNT_06)) 
df_07_city_total_fund <- df_07_city_spending %>% select(RECIPIENT_CITY_NAME) %>% group_by(RECIPIENT_CITY_NAME) %>% summarize(total_spending = sum(df_07_city_spending$FED_FUNDING_AMOUNT_07)) 
```

First I used left_join to join df_07_city_total_fund with df_06_city_total_fund. I found that there are many unmatched records in df_06_city_total_fund. So at this point, I am only intertested in the 
range and quatiles of 2007 city funding without comparing to 2006 city funding. Therefore I made an boxplot for that. From the graph, we can see that there are too many outliers in df_07_city_total_fund. The range is pretty big and the distribution is extremely skewed to the right

```{r}
join_by_city_left <- left_join(df_07_city_total_fund,df_06_city_total_fund,by = "RECIPIENT_CITY_NAME")
boxplot(join_by_city_left$total_spending.x)
```

Now I inner join two datasets by city to make more sense
```{r}
join_by_city <- inner_join(df_06_city_total_fund,df_07_city_total_fund,by = "RECIPIENT_CITY_NAME")
names(join_by_city) <- c("City","Total_fed_fund_06","Total_fed_fund_07")
```

Use bubble plot to visualize the gragh. First plot bubble plot: fed_fund_06 VS Cities
From the bubble graph, we can easily to see the difference of federal fund amount between these cities by the bubble size
```{r}
join_by_city %>% ggplot(aes(x=City, y=Total_fed_fund_06, size = Total_fed_fund_06,color=Total_fed_fund_06)) + geom_point() + theme(axis.text.x=element_text(angle=90, size=20, vjust=0.5)) + theme(axis.text.x=element_text(size=10, face="bold", vjust=1)) + theme(axis.title.x=element_text(color="forestgreen", vjust=0.35),axis.title.y=element_text(color="cadetblue", vjust=0.35)) + labs(title="Fed_fund_06 VS Cities",y="Total_fund",x="City")
```

Same for 2007
```{r}
join_by_city %>% ggplot(aes(x=City, y=Total_fed_fund_07, size = Total_fed_fund_07,color=Total_fed_fund_07)) + geom_point() + theme(axis.text.x=element_text(angle=90, size=20, vjust=0.5)) + theme(axis.text.x=element_text(size=10, face="bold", vjust=1)) + theme(axis.title.x=element_text(color="forestgreen", vjust=0.35),axis.title.y=element_text(color="cadetblue", vjust=0.35)) + labs(title="Fed_fund_07 VS Cities",y="Total_fund",x="City")
```

Now I will make a boxplot to see the range and quatiles of 2006 fund and 2007 fund 
```{r}
df_total_fund <- c(join_by_city$Total_fed_fund_06, join_by_city$Total_fed_fund_07)
df_total_fund <- data.frame(df_totol_fund)
df_year <- c(rep(c(2006),each=44),rep(c(2007),each=44))
df_year <- data.frame(df_year)
df_fund_year <- data.frame(df_total_fund,df_year)
names(df_fund_year) <- c("Total_fund","Year")
```

Plot the boxplot. Since there are many outliers in 2006 and 2007 as we can see, the boxplot is made to be very "narrow". But clearly we can see the median or fifty percentile in 2007 is bigger than that in 2006. Moreover, the total_fund of 2007 is more concentrated than that of 2006.
```{r}
df_fund_year %>% ggplot(aes(factor(Year),Total_fund)) + geom_boxplot() + theme(axis.text.x=element_text(size=10, face="bold", vjust=1)) + theme(axis.title.x=element_text(color="forestgreen", vjust=0.35),axis.title.y=element_text(color="cadetblue", vjust=0.35)) + labs(title="Boxplot",y="Total_fund",x="Year")
```


```{r}
names(dfpop) <- c('PRINCIPAL_PLACE_STATE','RECIPIENT_COUNTY_NAME','POPULATION')
df_state <- dfpop %>% select (PRINCIPAL_PLACE_STATE, POPULATION) %>% group_by(PRINCIPAL_PLACE_STATE) %>% summarise(sum(POPULATION))
df_state06 <- df_06 %>% select (PRINCIPAL_PLACE_STATE, FED_FUNDING_AMOUNT_06) %>% group_by(PRINCIPAL_PLACE_STATE) %>% summarise(sum(FED_FUNDING_AMOUNT_06))
df_state07 <- df_07 %>% select (PRINCIPAL_PLACE_STATE, FED_FUNDING_AMOUNT_07) %>% group_by(PRINCIPAL_PLACE_STATE) %>% summarise(sum(FED_FUNDING_AMOUNT_07))

dfsamestate <- inner_join(df_state06,df_state07,by = 'PRINCIPAL_PLACE_STATE')
mdf <- melt(dfsamestate, id.vars = 'PRINCIPAL_PLACE_STATE', measure.vars = c('sum(FED_FUNDING_AMOUNT_06)', 'sum(FED_FUNDING_AMOUNT_07)')) %>% ggplot(aes(x = PRINCIPAL_PLACE_STATE, y = value, color = variable)) + geom_point()



dffull <- full_join(df_state06,df_state07, by = 'PRINCIPAL_PLACE_STATE')
names(dffull) <- c('PRINCIPAL_PLACE_STATE','FED_FUNDING_AMOUNT_06','FED_FUNDING_AMOUNT_07')

dfsum <- dffull %>% select(FED_FUNDING_AMOUNT_06, FED_FUNDING_AMOUNT_07)  %>% summarise(T_FED_FUNDING_AMOUNT_06=cumsum(FED_FUNDING_AMOUNT_06), T_FED_FUNDING_AMOUNT_07 = cumsum(FED_FUNDING_AMOUNT_07))

dffull2 <- inner_join(dffull, df_state, by = 'PRINCIPAL_PLACE_STATE')
names(dffull2) <- c('PRINCIPAL_PLACE_STATE','FED_FUNDING_AMOUNT_06','FED_FUNDING_AMOUNT_07', 'POPULATION')
dffull3 <- dffull2 %>% mutate(perperson06 = FED_FUNDING_AMOUNT_06/POPULATION, perperson07 = FED_FUNDING_AMOUNT_07/POPULATION)
mdf2 <- melt(dffull3, id.vars = 'PRINCIPAL_PLACE_STATE', measure.vars= c('perperson06','perperson07'))
ggplot(mdf2,aes(x = PRINCIPAL_PLACE_STATE, y = value, color = variable)) + geom_point()  + theme(axis.text.x=element_text(angle=90, size=12, vjust=0.5)) + labs(title="Governmental Funding Broken Down\nPer Person",y="Total Funding per Person",x="State")
```

```{r}
categoricals <- eval(parse(text=substring(getURL(URLencode('http://129.152.144.84:5001/rest/native/?query="select * from GOVSPENDING2006"'), httpheader=c(DB='jdbc:oracle:thin:@129.152.144.84:1521:ORCL', USER='C##cs329e_jcn565', PASS='orcl_jcn565', MODE='native_mode', MODEL='model', returnFor = 'R', returnDimensions = 'True'), verbose = TRUE), 1, 2^31-1)))
# Need to insert image of the categorial variables we have. 

png("../00 Doc/categoricals.png", width = 25, height = 10, units = "in", res = 72)
grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 12)))   

print(categoricals, vp = viewport(layout.pos.row = 1, layout.pos.col = 1:4))
```
